"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = require("fs");
const path_1 = require("path");
const stream_1 = require("stream");
const debug = require("debug");
const throttle = require('lodash.throttle');
const mkdirp = require('mkdirp-promise');
const ffmpegPath = require('@ffmpeg-installer/ffmpeg').path;
const ffmpeg = require("fluent-ffmpeg");
const tempRoot = path_1.join(require('temp-dir'), 'pully');
const log = debug('pully:download');
const pully_core_1 = require("pully-core");
const models_1 = require("./models");
const analyzer_1 = require("./analyzer");
const speedometer_1 = require("../utils/speedometer");
const human_1 = require("../utils/human");
const TEMP_AUDIO_EXT = 'm4a';
const TEMP_VIDEO_EXT = 'mp4';
class Download {
    constructor(_config, _emitter) {
        this._config = _config;
        this._emitter = _emitter;
        this._totalBytes = 0;
        this._downloadedBytes = 0;
        this._tempFiles = [];
        this._speedometer = new speedometer_1.Speedometer();
        this._emitProgress = throttle((indeterminate) => {
            if (indeterminate) {
                this._config.progress && this._config.progress({ indeterminate });
                return;
            }
            const elapsed = Date.now() - this._start;
            this._speedometer.record(this._downloadedBytes);
            const eta = this._speedometer.eta(this._totalBytes);
            const progress = {
                indeterminate: false,
                downloadedBytes: this._downloadedBytes,
                totalBytes: this._totalBytes,
                progress: this._progress,
                percent: Math.floor(this._progress * 10000) / 100,
                bytesPerSecond: this._speedometer.bytesPerSecond,
                downloadSpeed: this._speedometer.currentSpeed,
                elapsed,
                elapsedStr: human_1.toHumanTime(elapsed / 1000),
                eta,
                etaStr: human_1.toHumanTime(eta)
            };
            log(`${progress.percent}% downloaded (${progress.downloadedBytes}/${progress.totalBytes}) [${progress.elapsedStr} -> ${progress.etaStr}]...`);
            this._emitter.emit('progress', { progress, config: this._config });
            this._config.progress && this._config.progress(progress);
        }, 500, { leading: true, trailing: true });
    }
    get _progress() {
        if (!this._totalBytes || !this._downloadedBytes) {
            return 0;
        }
        return this._downloadedBytes / this._totalBytes;
    }
    start() {
        return __awaiter(this, void 0, void 0, function* () {
            this._start = Date.now();
            let cancellationReason = yield this._getFormats();
            if (cancellationReason) {
                return { path: null, format: this._format, duration: (Date.now() - this._start), cancelled: true, reason: cancellationReason };
            }
            this._totalBytes += (this._format.audio ? (this._format.audio.downloadSize || 0) : 0);
            this._totalBytes += (this._format.video ? (this._format.video.downloadSize || 0) : 0);
            this._emitProgress(); // Emit zero progress...
            const path = yield this._beginDownload();
            this._cleanup();
            return { path, format: this._format, duration: (Date.now() - this._start), cancelled: false };
        });
    }
    _getFormats() {
        return __awaiter(this, void 0, void 0, function* () {
            this._format = yield analyzer_1.getBestFormats(this._config.url, this._config.preset);
            this._format.path = yield this._getOutputPath();
            let cancelledReason;
            yield Promise.resolve(this._config.info(this._format, (msg) => cancelledReason = msg));
            if (cancelledReason) {
                let cancelStr = `Download Cancelled: "${cancelledReason}".`;
                log(cancelStr);
                return cancelStr;
            }
            else {
                return null;
            }
        });
    }
    _beginDownload() {
        return __awaiter(this, void 0, void 0, function* () {
            switch (this._config.mode) {
                case models_1.DownloadMode.Merge:
                    return this._downloadAudioAndMergeVideo();
                case models_1.DownloadMode.Sequential:
                    return this._downloadAudioThenVideoThenMerge();
                case models_1.DownloadMode.Parallel:
                    return this._downloadAudioAndVideoThenMerge();
                case models_1.DownloadMode.Parts:
                    return this._downloadPartsThenMerge();
            }
        });
    }
    _downloadAudioAndMergeVideo() {
        return __awaiter(this, void 0, void 0, function* () {
            let audioPath = yield this._getTempPath(TEMP_AUDIO_EXT);
            audioPath = yield this._downloadFile(this._format.audio, audioPath);
            let videoStream = null;
            if (this._format.video)
                videoStream = this._getDownloadStream(this._format.video);
            return this._processOutput(this._format.path, audioPath, videoStream);
        });
    }
    _downloadAudioThenVideoThenMerge() {
        return __awaiter(this, void 0, void 0, function* () {
            let audioPath = yield this._getTempPath(TEMP_AUDIO_EXT);
            yield this._downloadFile(this._format.audio, audioPath);
            let videoPath = null;
            if (this._format.video) {
                videoPath = yield this._getTempPath(TEMP_VIDEO_EXT);
                yield this._downloadFile(this._format.video, videoPath);
            }
            return this._processOutput(this._format.path, audioPath, videoPath);
        });
    }
    _downloadAudioAndVideoThenMerge() {
        return __awaiter(this, void 0, void 0, function* () {
            let audioPath = yield this._getTempPath(TEMP_AUDIO_EXT);
            let audioPromise = this._downloadFile(this._format.audio, audioPath);
            let videoPath = null;
            let videoPromise = Promise.resolve(null);
            if (this._format.video) {
                videoPath = yield this._getTempPath(TEMP_VIDEO_EXT);
                videoPromise = this._downloadFile(this._format.video, videoPath);
            }
            yield Promise.all([audioPromise, videoPromise]);
            return this._processOutput(this._format.path, audioPath, videoPath);
        });
    }
    _downloadPartsThenMerge() {
        return __awaiter(this, void 0, void 0, function* () {
            throw new Error('Not yet implemented!');
        });
    }
    _getDownloadStream(format) {
        if (!this._format.data || !format) {
            throw new Error(`Missing required format!`);
        }
        return pully_core_1.downloadFromInfo(this._format.data.raw, format.raw).pipe(this._createProgressTracker());
    }
    _downloadFile(format, path) {
        return new Promise((resolve, reject) => {
            this._getDownloadStream(format)
                .pipe(fs_1.createWriteStream(path))
                .on('finish', () => resolve(path))
                .on('error', reject);
        });
    }
    _processOutput(outputPath, audioSrc, videoSrc) {
        let ffmpegCommand = this._createFfmpegCommand();
        if (this._config.preset.outputFormat) {
            ffmpegCommand = ffmpegCommand.format(this._config.preset.outputFormat);
        }
        if (audioSrc) {
            ffmpegCommand = ffmpegCommand.input(audioSrc);
            if (!this._config.preset.outputFormat)
                ffmpegCommand = ffmpegCommand.audioCodec('copy');
        }
        if (videoSrc) {
            ffmpegCommand = ffmpegCommand.input(videoSrc);
            if (!this._config.preset.outputFormat)
                ffmpegCommand = ffmpegCommand.videoCodec('copy');
        }
        return this._ffmpegSave(ffmpegCommand, outputPath, videoSrc && typeof videoSrc === 'string');
    }
    _getOutputPath() {
        return __awaiter(this, void 0, void 0, function* () {
            let ext = this._config.preset.outputFormat ? this._config.preset.outputFormat : (this._format.video || this._format.audio).container;
            let filename = this._config.template(this._format.data) + '.' + ext;
            let outDir = this._config.dir ? this._config.dir : tempRoot;
            return path_1.join(outDir, filename);
        });
    }
    _createProgressTracker() {
        return new stream_1.Transform({
            transform: (chunk, encoding, cb) => {
                this._downloadedBytes += chunk.length;
                this._emitProgress();
                cb(null, chunk);
            }
        });
    }
    _getTempPath(suffix) {
        return __awaiter(this, void 0, void 0, function* () {
            let tempPath = path_1.join(tempRoot, `${this._format.data.videoId}_${this._config.preset.name}.${suffix}`);
            yield mkdirp(tempRoot);
            this._tempFiles.push(tempPath);
            return tempPath;
        });
    }
    _createFfmpegCommand() {
        return ffmpeg()
            .setFfmpegPath(ffmpegPath)
            .outputOptions('-metadata', `title=${this._format.data.videoTitle}`)
            .outputOptions('-metadata', `author=${this._format.data.channelName}`).outputOptions('-metadata', `artist=${this._format.data.channelName}`)
            .outputOptions('-metadata', `description=${this._format.data.description}`).outputOptions('-metadata', `comment=${this._format.data.description}`)
            .outputOptions('-metadata', `episode_id=${this._format.data.videoId}`)
            .outputOptions('-metadata', `network=YouTube`);
    }
    _ffmpegSave(ffmpegCommand, path, indeterminate) {
        let dir = path_1.dirname(path);
        return mkdirp(dir).then(() => {
            return new Promise((resolve, reject) => {
                ffmpegCommand
                    .on('progress', (data) => this._emitProgress(indeterminate))
                    .on('error', (err, stdout, stderr) => {
                    console.error(JSON.stringify({ err, stdout, stderr }, null, '  '));
                    reject(err.message);
                })
                    .on('end', (stdout, stderr) => resolve(path))
                    .save(path);
            });
        });
    }
    _cleanup() {
        try {
            this._tempFiles.forEach(tempFile => {
                try {
                    fs_1.unlinkSync(tempFile);
                }
                catch (_a) { }
            });
        }
        catch (_a) { }
    }
}
exports.Download = Download;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG93bmxvYWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGliL2Rvd25sb2FkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSwyQkFBaUU7QUFDakUsK0JBQWlEO0FBQ2pELG1DQUE2QztBQUc3QywrQkFBK0I7QUFDL0IsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDNUMsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDekMsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUMsSUFBSSxDQUFDO0FBQzVELHdDQUF3QztBQUN4QyxNQUFNLFFBQVEsR0FBRyxXQUFRLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBRXhELE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBRXBDLDJDQUEyRDtBQUMzRCxxQ0FBMkc7QUFDM0cseUNBQTRDO0FBQzVDLHNEQUFtRDtBQUNuRCwwQ0FBNkM7QUFFN0MsTUFBTSxjQUFjLEdBQUcsS0FBSyxDQUFDO0FBQzdCLE1BQU0sY0FBYyxHQUFHLEtBQUssQ0FBQztBQUU3QixNQUFhLFFBQVE7SUFxQm5CLFlBQ1UsT0FBK0IsRUFDL0IsUUFBc0I7UUFEdEIsWUFBTyxHQUFQLE9BQU8sQ0FBd0I7UUFDL0IsYUFBUSxHQUFSLFFBQVEsQ0FBYztRQWJ4QixnQkFBVyxHQUFXLENBQUMsQ0FBQztRQUN4QixxQkFBZ0IsR0FBVyxDQUFDLENBQUM7UUFRN0IsZUFBVSxHQUFhLEVBQUUsQ0FBQztRQU1oQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUkseUJBQVcsRUFBRSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxhQUFhLEdBQUcsUUFBUSxDQUFDLENBQUMsYUFBdUIsRUFBRSxFQUFFO1lBRXhELElBQUksYUFBYSxFQUFFO2dCQUNqQixJ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